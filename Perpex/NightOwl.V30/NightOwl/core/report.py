from datetime import datetime
from pathlib import Path
import markdown2
import json

def generate_markdown_report(target, stats, errors, output_dir):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    important_path = output_dir / "important"
    vuln_path = output_dir / "vuln"

    report_lines = [
        f"# ğŸ¦‰ NightOwl Recon Report for `{target}`",
        f"ğŸ“… Scan Timestamp: **{now}**",
        f"ğŸ“ Output Directory: `{output_dir.resolve()}`",
        "\n---\n",
        "## âš™ï¸ Tool Results",
        "| Tool | Status | Duration | Output |",
        "|------|--------|----------|--------|"
    ]

    for stat in stats:
        icon = "âœ…" if stat.get("success") else "âŒ"
        
        # âœ” Safe duration formatting
        dur_val = stat.get("duration")
        dur = f"{dur_val:.2f}s" if isinstance(dur_val, (float, int)) else "-"

        out = stat.get("output", stat.get("error", "-")).replace(str(output_dir), "...")
        report_lines.append(f"| {stat.get('tool', 'unknown')} | {icon} | {dur} | `{out}` |")

    # âœ” Important Findings Section
    if important_path.exists():
        report_lines.append("\n## ğŸ” Important Info Extracted")
        for fname in ["emails.txt", "phones.txt", "names.txt", "secrets.txt"]:
            fpath = important_path / fname
            if fpath.exists():
                count = len(fpath.read_text(encoding="utf-8", errors='ignore').splitlines())
                report_lines.append(f"- `{fname}`: {count} match(es)")

    # âœ” Vulnerability Findings Section
    if vuln_path.exists():
        report_lines.append("\n## ğŸš¨ Vulnerabilities Detected")
        for f in ["cve_list.txt", "owasp_mapped.json", "critical_paths.txt"]:
            fpath = vuln_path / f
            if fpath.exists():
                lines = fpath.read_text(encoding="utf-8", errors='ignore').splitlines()
                report_lines.append(f"- `{f}`: {len(lines)} item(s)")

    # âœ” Error Section
    if errors:
        report_lines.append("\n## â— Errors/Failures Detected")
        for err in errors:
            report_lines.append(f"- ğŸ›‘ `{err.get('tool', 'unknown')}`: {err.get('error', '-')[:100]}")

    report_lines.append("\n---\n")
    report_lines.append("_Generated by NightOwl Elite â€¢ By n00bh4ck3r â€¢ Made in ğŸ‡®ğŸ‡³ India_")

    # âœ” Write Markdown report
    md_path = output_dir / "report.md"
    md_path.write_text("\n".join(report_lines), encoding="utf-8")
    return md_path


def render_html_report(md_path):
    html_content = markdown2.markdown(md_path.read_text(encoding="utf-8", errors="ignore"))
    html_output = md_path.with_suffix(".html")

    html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NightOwl Recon Report | {md_path.stem}</title>
    <style>
        body {{ font-family: sans-serif; margin: 2em; background: #f8f8f8; }}
        h1, h2, h3 {{ color: #333; }}
        table {{ border-collapse: collapse; width: 100%; margin-top: 1em; }}
        th, td {{ border: 1px solid #ccc; padding: 8px; text-align: left; }}
        th {{ background-color: #eee; }}
        code {{ background: #eee; padding: 2px 4px; border-radius: 4px; }}
        ul {{ padding-left: 1.5em; }}
    </style>
</head>
<body>
{html_content}
</body>
</html>
"""
    html_output.write_text(html, encoding="utf-8")
    return html_output
