import time
from zapv2 import ZAPv2
from core.error_handler import ErrorHandler

def run_zap_scan(target):
    """Run OWASP ZAP for API security scanning"""
    try:
        # ZAP configuration
        zap = ZAPv2(apikey=os.getenv("ZAP_API_KEY"), 
                   proxies={'http': 'http://127.0.0.1:8080', 
                            'https': 'http://127.0.0.1:8080'})
        
        # Start scan
        scan_id = zap.ascan.scan(target)
        
        # Monitor scan
        while int(zap.ascan.status(scan_id)) < 100:
            time.sleep(5)
        
        # Get results
        alerts = zap.core.alerts(baseurl=target)
        
        return {
            "tool": "zap",
            "status": "success",
            "data": alerts
        }
    except Exception as e:
        return {
            "tool": "zap",
            "status": "error",
            "message": str(e)
        }